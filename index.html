<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ«æ™šè¸ª - å¾’æ­¥ç«é€Ÿæ’è¡Œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        /* å¯¼èˆªæ  */
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
        }

        .logo {
            font-size: 1.5em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-links {
            display: flex;
            gap: 30px;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            opacity: 0.8;
            transition: opacity 0.3s;
            cursor: pointer;
        }

        .nav-links a:hover, .nav-links a.active {
            opacity: 1;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn {
            padding: 8px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: white;
            color: #667eea;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* é¡µé¢å†…å®¹ */
        .page {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .page.active {
            display: block;
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .card-title {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* æ’è¡Œé¡µæ ·å¼ */
        .route-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .route-btn {
            padding: 12px 24px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .route-btn:hover, .route-btn.active {
            border-color: #667eea;
            background: #f0f0ff;
            color: #667eea;
        }

        .period-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .period-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            font-size: 14px;
            position: relative;
        }

        .period-tab.active {
            color: #667eea;
            font-weight: 600;
        }

        .period-tab.active::after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 0;
            right: 0;
            height: 2px;
            background: #667eea;
        }

        /* æ’ååˆ—è¡¨ */
        .ranking-list {
            width: 100%;
        }

        .ranking-header {
            display: grid;
            grid-template-columns: 80px 1fr 150px 150px 100px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-weight: 600;
            color: #666;
            margin-bottom: 10px;
        }

        .ranking-item {
            display: grid;
            grid-template-columns: 80px 1fr 150px 150px 100px;
            padding: 15px;
            border-bottom: 1px solid #eee;
            align-items: center;
            transition: background 0.2s;
        }

        .ranking-item:hover {
            background: #f8f9fa;
        }

        .rank-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #999;
        }

        .rank-number.top3 {
            color: #ffd700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .time {
            font-family: monospace;
            font-size: 1.1em;
            color: #333;
        }

        .penalty {
            color: #e74c3c;
            font-size: 0.9em;
        }

        .deviation {
            color: #666;
            font-size: 0.9em;
        }

        /* ä¸Šä¼ é¡µé¢ */
        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 12px;
            padding: 60px 40px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .upload-text {
            color: #666;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #999;
            font-size: 0.9em;
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .file-icon {
            font-size: 24px;
        }

        .file-name {
            font-weight: 500;
        }

        .file-size {
            color: #999;
            font-size: 0.9em;
        }

        .file-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-pending { color: #999; }
        .status-processing { color: #f39c12; }
        .status-success { color: #27ae60; }
        .status-error { color: #e74c3c; }

        /* çº¿è·¯é€‰æ‹© */
        .route-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .route-card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .route-card:hover, .route-card.selected {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .route-card.selected {
            background: #f0f0ff;
        }

        .route-name {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .route-stats {
            display: flex;
            gap: 15px;
            color: #666;
            font-size: 0.9em;
        }

        .route-stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* ç»“æœå±•ç¤º */
        .result-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 30px;
            margin-top: 20px;
        }

        .result-title {
            font-size: 1.2em;
            margin-bottom: 20px;
            opacity: 0.9;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .result-item {
            text-align: center;
        }

        .result-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .result-label {
            opacity: 0.8;
            font-size: 0.9em;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }

            .ranking-header, .ranking-item {
                grid-template-columns: 50px 1fr 100px;
            }

            .ranking-header > :nth-child(4),
            .ranking-header > :nth-child(5),
            .ranking-item > :nth-child(4),
            .ranking-item > :nth-child(5) {
                display: none;
            }

            .result-grid {
                grid-template-columns: 1fr;
            }
        }

        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
        }

        .modal-title {
            font-size: 1.3em;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-actions .btn {
            flex: 1;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">ğŸ”ï¸ å³°ç©å®—</div>
            <div class="nav-links">
                <a href="#" class="active" data-page="ranking">æ’è¡Œæ¦œ</a>
                <a href="#" data-page="upload">ä¸Šä¼ æˆç»©</a>
                <a href="#" data-page="my">æˆ‘çš„æˆç»©</a>
                <a href="#" data-page="admin" id="adminLink" style="display:none;">ç®¡ç†</a>
            </div>
            <div class="user-menu">
                <span id="username" style="display:none;"></span>
                <button class="btn btn-primary" id="loginBtn">ç™»å½•</button>
                <button class="btn btn-secondary" id="logoutBtn" style="display:none;">é€€å‡º</button>
            </div>
        </div>
    </nav>

    <!-- æ’è¡Œé¡µ -->
    <div class="page active" id="rankingPage">
        <div class="card">
            <div class="card-title">ğŸ“ é€‰æ‹©çº¿è·¯</div>
            <div class="route-grid" id="routeList">
                <!-- åŠ¨æ€åŠ è½½ -->
                <div class="empty-state">
                    <div class="empty-icon">ğŸ—ºï¸</div>
                    <p>æš‚æ— çº¿è·¯æ•°æ®</p>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">ğŸ† æˆç»©æ’è¡Œ</div>
            <div class="period-tabs">
                <button class="period-tab active" data-period="day">æ—¥æ¦œ</button>
                <button class="period-tab" data-period="week">å‘¨æ¦œ</button>
                <button class="period-tab" data-period="month">æœˆæ¦œ</button>
                <button class="period-tab" data-period="year">å¹´æ¦œ</button>
                <button class="period-tab" data-period="all">æ€»æ¦œ</button>
            </div>
            <div class="ranking-list" id="rankingList">
                <div class="ranking-header">
                    <div>æ’å</div>
                    <div>é€‰æ‰‹</div>
                    <div>æ ‡å‡†åŒ–ç”¨æ—¶</div>
                    <div>åç¦»</div>
                    <div>æ—¥æœŸ</div>
                </div>
                <div id="rankingContent">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“Š</div>
                        <p>è¯·é€‰æ‹©çº¿è·¯æŸ¥çœ‹æ’å</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸Šä¼ é¡µ -->
    <div class="page" id="uploadPage">
        <div class="card">
            <div class="card-title">ğŸ—ºï¸ é€‰æ‹©çº¿è·¯</div>
            <div class="route-grid" id="uploadRouteList">
                <div class="empty-state">
                    <div class="empty-icon">ğŸ—ºï¸</div>
                    <p>è¯·å…ˆé€‰æ‹©è¦ä¸Šä¼ çš„çº¿è·¯</p>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">ğŸ“¤ ä¸Šä¼ è½¨è¿¹</div>
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">æ‹–æ‹½ KML æ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</div>
                <div class="upload-hint">æ”¯æŒ ä¸¤æ­¥è·¯ã€åä¸ºè¿åŠ¨å¥åº·ã€Garmin ç­‰å¯¼å‡ºçš„ KML æ–‡ä»¶</div>
                <input type="file" id="fileInput" accept=".kml" style="display:none;">
            </div>
            <div class="file-list" id="fileList"></div>
            <button class="btn btn-primary" id="startUploadBtn" style="margin-top:20px;width:100%;display:none;">å¼€å§‹ä¸Šä¼ å¹¶è®¡ç®—æˆç»©</button>
        </div>

        <div class="loading" id="uploadLoading">
            <div class="spinner"></div>
            <p>æ­£åœ¨å¤„ç†è½¨è¿¹æ•°æ®...</p>
        </div>

        <div id="uploadResult"></div>
    </div>

    <!-- æˆ‘çš„æˆç»©é¡µ -->
    <div class="page" id="myPage">
        <div class="card">
            <div class="card-title">ğŸ“Š æˆ‘çš„æˆç»©ç»Ÿè®¡</div>
            <div class="result-grid" id="myStats">
                <div class="result-item">
                    <div class="result-value" id="totalRecords">0</div>
                    <div class="result-label">æ€»è®°å½•</div>
                </div>
                <div class="result-item">
                    <div class="result-value" id="totalRoutes">0</div>
                    <div class="result-label">å®Œæˆçº¿è·¯</div>
                </div>
                <div class="result-item">
                    <div class="result-value" id="bestRank">-</div>
                    <div class="result-label">æœ€ä½³æ’å</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">ğŸ“‹ å†å²è®°å½•</div>
            <div id="myRecords">
                <div class="empty-state">
                    <div class="empty-icon">ğŸ“</div>
                    <p>æš‚æ— æˆç»©è®°å½•</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ç®¡ç†é¡µ -->
    <div class="page" id="adminPage">
        <div class="card">
            <div class="card-title">â• æ·»åŠ æ–°çº¿è·¯</div>
            <div class="form-group">
                <label>çº¿è·¯åç§°</label>
                <input type="text" id="newRouteName" placeholder="ä¾‹å¦‚ï¼šå²³éº“å±±çˆ±å¿ƒçº¿">
            </div>
            <div class="form-group">
                <label>çº¿è·¯æè¿°</label>
                <input type="text" id="newRouteDesc" placeholder="ç®€çŸ­æè¿°çº¿è·¯ç‰¹ç‚¹">
            </div>
            <div class="upload-area" id="routeUploadArea">
                <div class="upload-icon">ğŸ—ºï¸</div>
                <div class="upload-text">ä¸Šä¼ æ ‡å‡†çº¿è·¯ KML æ–‡ä»¶</div>
                <div class="upload-hint">æ­¤æ–‡ä»¶å°†ä½œä¸ºæˆç»©è®¡ç®—çš„åŸºå‡†çº¿è·¯</div>
                <input type="file" id="routeFileInput" accept=".kml" style="display:none;">
            </div>
            <button class="btn btn-primary" id="createRouteBtn" style="margin-top:20px;width:100%;">åˆ›å»ºçº¿è·¯</button>
        </div>

        <div class="card">
            <div class="card-title">ğŸ“‹ çº¿è·¯ç®¡ç†</div>
            <div id="adminRouteList">
                <div class="empty-state">
                    <div class="empty-icon">ğŸ—ºï¸</div>
                    <p>æš‚æ— çº¿è·¯</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-title">ğŸ” ç”¨æˆ·ç™»å½•</div>
            <div class="form-group">
                <label>æ˜µç§°</label>
                <input type="text" id="loginNickname" placeholder="è¾“å…¥ä½ çš„æ˜µç§°">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancelLogin">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="confirmLogin">ç™»å½•</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== å…¨å±€é…ç½® ====================
        const SUPABASE_URL = 'https://wwlyxkgoncbxqhfgkggx.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_hkcfTRLfAXDvgWKVQ8zC6Q_JAlZInVB';
        
        // ==================== çŠ¶æ€ç®¡ç† ====================
        const state = {
            currentUser: null,
            routes: [],
            selectedRoute: null,
            currentPeriod: 'day',
            rankings: [],
            myRecords: []
        };

        // ==================== é¡µé¢åˆ‡æ¢ ====================
        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
            
            document.getElementById(pageName + 'Page').classList.add('active');
            document.querySelector(`[data-page="${pageName}"]`).classList.add('active');

            // åŠ è½½é¡µé¢æ•°æ®
            if (pageName === 'ranking') loadRoutes();
            if (pageName === 'upload') loadRoutesForUpload();
            if (pageName === 'my' && state.currentUser) loadMyRecords();
            if (pageName === 'admin') loadAdminRoutes();
        }

        document.querySelectorAll('.nav-links a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const page = e.target.dataset.page;
                if (page === 'my' && !state.currentUser) {
                    showLoginModal();
                    return;
                }
                showPage(page);
            });
        });

        // ==================== ç™»å½•åŠŸèƒ½ ====================
        function showLoginModal() {
            document.getElementById('loginModal').classList.add('show');
        }

        function hideLoginModal() {
            document.getElementById('loginModal').classList.remove('show');
        }

        document.getElementById('loginBtn').addEventListener('click', showLoginModal);
        document.getElementById('cancelLogin').addEventListener('click', hideLoginModal);

        document.getElementById('confirmLogin').addEventListener('click', async () => {
            const nickname = document.getElementById('loginNickname').value.trim();
            if (!nickname) {
                alert('è¯·è¾“å…¥æ˜µç§°');
                return;
            }

            // åˆ›å»ºç”¨æˆ·ï¼ˆç®€åŒ–ç‰ˆï¼Œå®é™…åº”è¯¥è°ƒç”¨åç«¯APIï¼‰
            state.currentUser = {
                id: 'user_' + Date.now(),
                nickname: nickname,
                role: nickname === 'admin' ? 'admin' : 'user'
            };

            updateUserUI();
            hideLoginModal();
            
            if (state.currentUser.role === 'admin') {
                document.getElementById('adminLink').style.display = 'inline';
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            state.currentUser = null;
            updateUserUI();
            document.getElementById('adminLink').style.display = 'none';
            showPage('ranking');
        });

        function updateUserUI() {
            if (state.currentUser) {
                document.getElementById('username').textContent = state.currentUser.nickname;
                document.getElementById('username').style.display = 'inline';
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'inline';
            } else {
                document.getElementById('username').style.display = 'none';
                document.getElementById('loginBtn').style.display = 'inline';
                document.getElementById('logoutBtn').style.display = 'none';
            }
        }

        // ==================== çº¿è·¯åŠ è½½ ====================
        async function loadRoutes() {
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/api-routes/routes`, {
                    headers: { 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
                });
                const result = await response.json();
                
                if (result.success) {
                    state.routes = result.data;
                }
            } catch (error) {
                console.error('åŠ è½½çº¿è·¯å¤±è´¥:', error);
            }

            const container = document.getElementById('routeList');
            if (state.routes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ—ºï¸</div>
                        <p>æš‚æ— çº¿è·¯æ•°æ®</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = state.routes.map(route => `
                <div class="route-card ${state.selectedRoute?.id === route.id ? 'selected' : ''}" data-route-id="${route.id}">
                    <div class="route-name">${route.name}</div>
                    <div class="route-stats">
                        <div class="route-stat">ğŸ“ ${(route.distance/1000).toFixed(2)}km</div>
                        <div class="route-stat">â›°ï¸ ${route.elevation}m</div>
                        <div class="route-stat">ğŸ‘¥ ${route.recordCount}äºº</div>
                    </div>
                </div>
            `).join('');

            container.querySelectorAll('.route-card').forEach(card => {
                card.addEventListener('click', () => {
                    const routeId = card.dataset.routeId;
                    state.selectedRoute = state.routes.find(r => r.id === routeId);
                    loadRoutes();
                    loadRankings();
                });
            });
        }

        function loadRoutesForUpload() {
            const container = document.getElementById('uploadRouteList');
            if (state.routes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ—ºï¸</div>
                        <p>æš‚æ— å¯ç”¨çº¿è·¯</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = state.routes.map(route => `
                <div class="route-card ${state.selectedRoute?.id === route.id ? 'selected' : ''}" data-route-id="${route.id}">
                    <div class="route-name">${route.name}</div>
                    <div class="route-stats">
                        <div class="route-stat">ğŸ“ ${(route.distance/1000).toFixed(2)}km</div>
                        <div class="route-stat">â›°ï¸ ${route.elevation}m</div>
                    </div>
                </div>
            `).join('');

            container.querySelectorAll('.route-card').forEach(card => {
                card.addEventListener('click', () => {
                    const routeId = card.dataset.routeId;
                    state.selectedRoute = state.routes.find(r => r.id === routeId);
                    loadRoutesForUpload();
                });
            });
        }

        // ==================== æ’è¡Œæ¦œ ====================
        document.querySelectorAll('.period-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.period-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                state.currentPeriod = tab.dataset.period;
                loadRankings();
            });
        });

        async function loadRankings() {
            if (!state.selectedRoute) return;

            const container = document.getElementById('rankingContent');
            container.innerHTML = '<div class="loading show"><div class="spinner"></div><p>åŠ è½½ä¸­...</p></div>';

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/functions/v1/api-rankings/rankings?routeId=${state.selectedRoute.id}&period=${state.currentPeriod}`,
                    { headers: { 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` } }
                );
                const result = await response.json();

                if (result.success && result.data.length > 0) {
                    container.innerHTML = result.data.map((item, index) => `
                        <div class="ranking-item">
                            <div class="rank-number ${index < 3 ? 'top3' : ''}">${item.rank}</div>
                            <div class="user-info">
                                <div class="avatar">${item.name[0]}</div>
                                <span>${item.name}</span>
                            </div>
                            <div class="time">${formatTime(item.time)}</div>
                            <div class="deviation">${item.deviation?.toFixed(1) || '-'}m</div>
                            <div>${item.date}</div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ“Š</div>
                            <p>æš‚æ— æ’åæ•°æ®</p>
                        </div>
                    `;
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">âŒ</div>
                        <p>åŠ è½½å¤±è´¥: ${error.message}</p>
                    </div>
                `;
            }
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        // ==================== æ–‡ä»¶ä¸Šä¼  ====================
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const startUploadBtn = document.getElementById('startUploadBtn');
        let selectedFile = null;
        let selectedFileContent = null;

        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFileSelect(e.dataTransfer.files[0]);
        });

        fileInput.addEventListener('change', (e) => {
            handleFileSelect(e.target.files[0]);
        });

        function handleFileSelect(file) {
            if (!state.selectedRoute) {
                alert('è¯·å…ˆé€‰æ‹©çº¿è·¯');
                return;
            }

            if (!file || !file.name.endsWith('.kml')) {
                alert('è¯·é€‰æ‹©KMLæ–‡ä»¶');
                return;
            }

            selectedFile = file;
            
            // è¯»å–æ–‡ä»¶å†…å®¹
            const reader = new FileReader();
            reader.onload = (e) => {
                selectedFileContent = e.target.result;
                
                // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
                fileList.innerHTML = `
                    <div class="file-item">
                        <div class="file-info">
                            <div class="file-icon">ğŸ“„</div>
                            <div>
                                <div class="file-name">${file.name}</div>
                                <div class="file-size">${(file.size/1024).toFixed(1)} KB</div>
                            </div>
                        </div>
                        <div class="file-status">
                            <span class="status-pending">ç­‰å¾…ä¸Šä¼ </span>
                        </div>
                    </div>
                `;
                
                // æ˜¾ç¤ºä¸Šä¼ æŒ‰é’®
                startUploadBtn.style.display = 'block';
            };
            reader.readAsText(file);
        }

        startUploadBtn.addEventListener('click', async () => {
            if (!selectedFile || !selectedFileContent) {
                alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
                return;
            }

            startUploadBtn.disabled = true;
            startUploadBtn.textContent = 'å¤„ç†ä¸­...';
            document.querySelector('.file-status').innerHTML = '<span class="status-processing">è®¡ç®—ä¸­...</span>';

            try {
                // 1. è·å–æ ‡å‡†çº¿è·¯KML
                const routeResponse = await fetch(
                    `${SUPABASE_URL}/functions/v1/api-routes/routes`,
                    { headers: { 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` } }
                );
                const routeResult = await routeResponse.json();
                const standardRoute = routeResult.data.find(r => r.id === state.selectedRoute.id);
                
                if (!standardRoute || !standardRoute.kml_content) {
                    throw new Error('æ— æ³•è·å–æ ‡å‡†çº¿è·¯æ•°æ®');
                }

                // 2. è°ƒç”¨ complete-pipeline è®¡ç®—æˆç»©
                const response = await fetch(`${SUPABASE_URL}/functions/v1/complete-pipeline`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        standardKML: standardRoute.kml_content,
                        athleteKML: selectedFileContent,
                        athleteName: state.currentUser?.nickname || 'åŒ¿åç”¨æˆ·',
                        tolerance: 20,
                        epsilon: 5,
                        minPoints: 300
                    })
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error);
                }

                // 3. ä¿å­˜æˆç»©åˆ°æ•°æ®åº“ï¼ˆè½¬æ¢ä¸ºæ•´æ•°ï¼‰
                const saveResponse = await fetch(`${SUPABASE_URL}/functions/v1/api-scores/submit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        athleteName: state.currentUser?.nickname || 'åŒ¿åç”¨æˆ·',
                        standardTrackId: state.selectedRoute.id,
                        athleteKML: selectedFileContent,
                        normalizedTime: Math.round(result.data.totalNormalizedTime),
                        actualTime: Math.round(result.data.totalActualTime),
                        penaltyTime: Math.round(result.data.totalPenaltyTime),
                        stdDistance: Math.round(result.data.totalStdDistance),
                        athleteDistance: Math.round(result.data.totalAthleteDistance),
                        avgDeviation: Math.round(result.data.avgDeviation),
                        maxDeviation: Math.round(result.data.maxDeviation),
                        processingInfo: result.processing
                    })
                });

                const saveResult = await saveResponse.json();

                if (saveResult.success) {
                    document.querySelector('.file-status').innerHTML = 
                        `<span class="status-success">âœ“ å·²ä¿å­˜</span>`;
                    showUploadResult(result.data);
                    startUploadBtn.textContent = 'ä¸Šä¼ æˆåŠŸ';
                } else {
                    throw new Error(saveResult.error || 'ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                document.querySelector('.file-status').innerHTML = 
                    `<span class="status-error">âœ— ${error.message}</span>`;
                startUploadBtn.disabled = false;
                startUploadBtn.textContent = 'é‡è¯•';
            }
        });

        function showUploadResult(data) {
            const container = document.getElementById('uploadResult');
            container.innerHTML = `
                <div class="result-card">
                    <div class="result-title">ğŸ‰ æˆç»©è®¡ç®—å®Œæˆ</div>
                    <div class="result-grid">
                        <div class="result-item">
                            <div class="result-value">${formatTime(data.totalNormalizedTime)}</div>
                            <div class="result-label">æ ‡å‡†åŒ–ç”¨æ—¶</div>
                        </div>
                        <div class="result-item">
                            <div class="result-value">${formatTime(data.totalActualTime)}</div>
                            <div class="result-label">å®é™…ç”¨æ—¶</div>
                        </div>
                        <div class="result-item">
                            <div class="result-value">${formatTime(data.totalPenaltyTime)}</div>
                            <div class="result-label">æƒ©ç½šæ—¶é—´</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== æˆ‘çš„æˆç»© ====================
        async function loadMyRecords() {
            if (!state.currentUser) return;

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/functions/v1/api-scores/my?name=${encodeURIComponent(state.currentUser.nickname)}`,
                    { headers: { 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` } }
                );
                const result = await response.json();

                if (result.success) {
                    const records = result.data;
                    document.getElementById('totalRecords').textContent = records.length;
                    document.getElementById('totalRoutes').textContent = new Set(records.map(r => r.routeName)).size;
                    document.getElementById('bestRank').textContent = records.length > 0 ? '-' : '-';

                    const recordsContainer = document.getElementById('myRecords');
                    if (records.length === 0) {
                        recordsContainer.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">ğŸ“</div>
                                <p>æš‚æ— æˆç»©è®°å½•</p>
                            </div>
                        `;
                        return;
                    }

                    recordsContainer.innerHTML = `
                        <div class="ranking-header">
                            <div>çº¿è·¯</div>
                            <div>æ—¥æœŸ</div>
                            <div>æ ‡å‡†åŒ–ç”¨æ—¶</div>
                            <div>åç¦»</div>
                            <div>æ“ä½œ</div>
                        </div>
                        ${records.map(record => `
                            <div class="ranking-item">
                                <div>${record.routeName}</div>
                                <div>${record.date}</div>
                                <div class="time">${formatTime(record.normalizedTime)}</div>
                                <div>${record.deviation?.toFixed(1) || '-'}m</div>
                                <div><button class="btn btn-primary" style="padding:5px 15px;" onclick="shareResult('${record.id}')">åˆ†äº«</button></div>
                            </div>
                        `).join('')}
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½æˆç»©å¤±è´¥:', error);
            }
        }

        function shareResult(recordId) {
            alert('åˆ†äº«åŠŸèƒ½å¼€å‘ä¸­...');
        }

        // ==================== ç®¡ç†å‘˜åŠŸèƒ½ ====================
        let routeKMLContent = null;
        const routeUploadArea = document.getElementById('routeUploadArea');
        const routeFileInput = document.getElementById('routeFileInput');

        routeUploadArea.addEventListener('click', () => routeFileInput.click());
        
        routeFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    routeKMLContent = event.target.result;
                    routeUploadArea.innerHTML = `
                        <div class="upload-icon">âœ“</div>
                        <div class="upload-text">å·²é€‰æ‹©: ${file.name}</div>
                        <div class="upload-hint">${(file.size/1024).toFixed(1)} KB</div>
                    `;
                };
                reader.readAsText(file);
            }
        });

        document.getElementById('createRouteBtn').addEventListener('click', async () => {
            const name = document.getElementById('newRouteName').value.trim();
            const desc = document.getElementById('newRouteDesc').value.trim();
            
            if (!name) {
                alert('è¯·è¾“å…¥çº¿è·¯åç§°');
                return;
            }

            if (!routeKMLContent) {
                alert('è¯·ä¸Šä¼ KMLæ–‡ä»¶');
                return;
            }

            const btn = document.getElementById('createRouteBtn');
            btn.textContent = 'åˆ›å»ºä¸­...';
            btn.disabled = true;

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/api-routes/routes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        name,
                        description: desc,
                        kmlContent: routeKMLContent
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('çº¿è·¯åˆ›å»ºæˆåŠŸï¼');
                    // é‡ç½®è¡¨å•
                    document.getElementById('newRouteName').value = '';
                    document.getElementById('newRouteDesc').value = '';
                    routeKMLContent = null;
                    routeUploadArea.innerHTML = `
                        <div class="upload-icon">ğŸ—ºï¸</div>
                        <div class="upload-text">ä¸Šä¼ æ ‡å‡†çº¿è·¯ KML æ–‡ä»¶</div>
                        <div class="upload-hint">æ­¤æ–‡ä»¶å°†ä½œä¸ºæˆç»©è®¡ç®—çš„åŸºå‡†çº¿è·¯</div>
                    `;
                    // åˆ·æ–°çº¿è·¯åˆ—è¡¨
                    loadRoutes();
                    loadAdminRoutes();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                alert('åˆ›å»ºå¤±è´¥: ' + error.message);
            } finally {
                btn.textContent = 'åˆ›å»ºçº¿è·¯';
                btn.disabled = false;
            }
        });

        function loadAdminRoutes() {
            const container = document.getElementById('adminRouteList');
            container.innerHTML = state.routes.map(route => `
                <div class="file-item">
                    <div class="file-info">
                        <div class="file-icon">ğŸ—ºï¸</div>
                        <div>
                            <div class="file-name">${route.name}</div>
                            <div class="file-size">${route.recordCount} æ¡è®°å½•</div>
                        </div>
                    </div>
                    <div class="file-status">
                        <button class="btn btn-secondary" style="margin-right:10px;">ç¼–è¾‘</button>
                        <button class="btn btn-primary">æŸ¥çœ‹</button>
                    </div>
                </div>
            `).join('');
        }

        // ==================== åˆå§‹åŒ– ====================
        loadRoutes();
    </script>
</body>
</html>
